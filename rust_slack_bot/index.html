<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <!-- viewport-fit=cover is to support iPhone X rounded corners and notch in landscape-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

      <title>Ion Ostafi</title>

      <!-- CSS -->
      <link rel="stylesheet" href="https:&#x2F;&#x2F;bprog.github.io&#x2F;print.css" media="print">
      <link rel="stylesheet" href="https:&#x2F;&#x2F;bprog.github.io&#x2F;poole.css">
      <link rel="stylesheet" href="https:&#x2F;&#x2F;bprog.github.io&#x2F;hyde.css">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

      

      
      
    </head>

    <body class=" ">
        
            <div class="sidebar">
                <div class="container sidebar-sticky">
                    <div class="sidebar-about">
                        
                            <a href="https:&#x2F;&#x2F;bprog.github.io"><h1>Ion Ostafi</h1></a>
                            
                            <p class="lead">‚ÄùProgramming isn‚Äôt about what you know; it‚Äôs about what you can figure out.‚Äù - Chris Pine</p>
                            
                        
                    </div>

                    <ul class="sidebar-nav">
                        
                        
                        <li class="sidebar-nav-item"><a href="mailto:ostafi_ion@yahoo.com">ostafi_ion@yahoo.com</a></li>
                        
                        
                    </ul>
                </div>
            </div>
        

        <div class="content container">
            
<div class="post">
  <h1 class="post-title">Rust cli app integrated with slack</h1>
  <span class="post-date">2020-06-03</span>
  <p>The intention was to have a better overview about rust in the field (real world use case). So I decided to create an app with the following requirements</p>
<p><strong>Read git history for a git project, selects commits made a year back in the same day as today, formats a pretty message with some emojis and sends it to a slack channel. The app is a cli app, with ability to install it as an osx launch agent, and configure what is necessary.</strong> <em>The final product is on <a href="https://github.com/BProg/git-retro-slack">github</a>.</em></p>
<p>Slack demo</p>
<p><img src="./gitretro_final.png" alt="final" /></p>
<h2 id="contents">Contents</h2>
<ul>
<li><a href="https://bprog.github.io/rust_slack_bot/#sending-messages-to-slack">Sending messages to slack</a></li>
<li><a href="https://bprog.github.io/rust_slack_bot/#reading-git-commits">Reading git commits</a></li>
<li><a href="https://bprog.github.io/rust_slack_bot/#getting-time-range-for-one-day-a-year-ago">Getting time range for one day a year ago</a></li>
<li><a href="https://bprog.github.io/rust_slack_bot/#creating-the-slack-message">Creating the slack message</a></li>
<li><a href="https://bprog.github.io/rust_slack_bot/#configuration">Configuration</a></li>
<li><a href="https://bprog.github.io/rust_slack_bot/#daemonize-the-process">Daemonize the process</a></li>
<li><a href="https://bprog.github.io/rust_slack_bot/#commands">Commands</a></li>
<li><a href="https://bprog.github.io/rust_slack_bot/#environments">Environments</a></li>
<li><a href="https://bprog.github.io/rust_slack_bot/#conclusion">Conclusion</a></li>
</ul>
<h2 id="sending-messages-to-slack"><a href="https://bprog.github.io/rust_slack_bot/#sending-messages-to-slack">Sending messages to slack</a></h2>
<p>Slack allows to create apps and have a pretty good <a href="https://api.slack.com/">documentation</a>. I was searching for a way to post a message to a channel, and I found <a href="https://api.slack.com/start/planning/communicating">incoming web hooks</a>. This was what I needed, a POST https request with the message I want, great üëçüèº</p>
<p>The app I needed to write, would live and run on my MacBook, and it would send messages to slack. I needed a command line application.</p>
<p>First I need to create an app thru slack web interface, <a href="https://api.slack.com/apps">here</a>. Next, in the app's settings, under <strong>Features &gt; Incoming Webhooks</strong>, activate the webhooks, and add a channel. <em>For development purposes I have added myself, my app would send messages to me</em>.</p>
<p>I am not a pro when it comes to low level network requests, so I googled to find a create to send HTTP requests. I found <a href="https://crates.io/crates/reqwest">reqwest</a> crate.</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">async </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">send_to_slack</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">hook</span><span style="color:#c0c5ce;">: &amp;</span><span style="color:#b48ead;">str</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">log</span><span style="color:#c0c5ce;">: &amp;String) -&gt; Result&lt;reqwest::Response, reqwest::Error&gt; {
    </span><span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> client = Client::new();
    client
        .</span><span style="color:#96b5b4;">post</span><span style="color:#c0c5ce;">(hook) </span><span style="color:#65737e;">// the web hook url
        </span><span style="color:#c0c5ce;">.</span><span style="color:#96b5b4;">body</span><span style="color:#c0c5ce;">(format!(&quot;</span><span style="color:#96b5b4;">{{\&quot;</span><span style="color:#a3be8c;">text</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">: </span><span style="color:#96b5b4;">\&quot;</span><span style="color:#d08770;">{}</span><span style="color:#96b5b4;">\&quot;}}</span><span style="color:#c0c5ce;">&quot;, log))  </span><span style="color:#65737e;">// the message to send to slack
        </span><span style="color:#c0c5ce;">.</span><span style="color:#96b5b4;">send</span><span style="color:#c0c5ce;">()
        .await
}
</span></pre>
<p>The problem was how to use the <code>async</code> functions from the <code>main</code> function. Rust does not allow to write the <code>main</code> function as <code>async</code>. After some reading and browsing the internet, I found that rust by default does not use any <em>async runtime</em>, it is the programmer's choice which runtime to use. <a href="https://crates.io/crates/tokio">tokio</a> is such a runtime.</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">#[</span><span style="color:#bf616a;">tokio</span><span style="color:#c0c5ce;">::</span><span style="color:#bf616a;">main</span><span style="color:#c0c5ce;">]
async </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">main</span><span style="color:#c0c5ce;">() {
    </span><span style="color:#96b5b4;">send_to_slack</span><span style="color:#c0c5ce;">().await
}
</span></pre><h2 id="reading-git-commits"><a href="https://bprog.github.io/rust_slack_bot/#reading-git-commits">Reading git commits</a></h2>
<p>Reading log from git wasn't as easy as I thought. The crate that I have used is <a href="https://crates.io/crates/git2">git2</a>. It is wrapping <a href="https://github.com/libgit2/libgit2">libgit2</a> written in C.</p>
<p>I was imagining I would just call a <code>log</code> function with same arguments as I pass in the <code>git</code> cli. But it's not so easy, there is no such a function as <code>log</code> in the api.</p>
<p>If there is no <code>log</code> function, how does <code>log</code> works? The <code>gitlib2</code> has a nice documentation with some examples, and I found the example of the <code>log</code> <a href="https://libgit2.org/libgit2/ex/HEAD/log.html">here</a>. I was reading the file and the description on the right and found that <code>log</code> is using <a href="https://libgit2.org/libgit2/ex/HEAD/log.html#section-9">revwalk</a> to walk thru commits. It uses <a href="https://libgit2.org/libgit2/#HEAD/group/revwalk/git_revwalk_next">git_revwalk_next</a> to read the next commit.</p>
<p>In rust, <a href="https://docs.rs/git2/0.13.6/git2/struct.Revwalk.html">Revwalk</a> is a struct which implements <a href="https://docs.rs/git2/0.13.6/git2/struct.Revwalk.html#impl-Iterator">Iterator</a> trait. Very convenient to iterate thru commits. I can use all the rust iterator advantages üí™.</p>
<p>My first try was similar to this</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">if let </span><span style="color:#c0c5ce;">Ok(repo) = Repository::open(&amp;path) {
    </span><span style="color:#b48ead;">if let </span><span style="color:#c0c5ce;">Ok(</span><span style="color:#b48ead;">mut</span><span style="color:#c0c5ce;"> revwalk) = repo.</span><span style="color:#96b5b4;">revwalk</span><span style="color:#c0c5ce;">() {
        println!(&quot;</span><span style="color:#d08770;">{:?}</span><span style="color:#c0c5ce;">&quot;, revwalk.</span><span style="color:#96b5b4;">next</span><span style="color:#c0c5ce;">());
    } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
        println!(&quot;</span><span style="color:#a3be8c;">error revwalk</span><span style="color:#c0c5ce;">&quot;);
    }
} </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
    println!(&quot;</span><span style="color:#a3be8c;">error repo</span><span style="color:#c0c5ce;">&quot;);
}
</span></pre>
<p>It didn't work. The code is correct, it compiles, it sounds similar to what I saw in <code>log.c</code> file, but there is one thing I missed. There is a statement in git2 rust documentation: <strong>At least one commit must be pushed onto the walker before a walk can be started.</strong> I needed to push a starting commit from where I want to start <em>walking</em> the commits. There is a function that does exactly what I needed: <code>push_head</code></p>
<p>This time it worked üôå</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">if let </span><span style="color:#c0c5ce;">Ok(repo) = Repository::open(&amp;path) {
    </span><span style="color:#b48ead;">if let </span><span style="color:#c0c5ce;">Ok(</span><span style="color:#b48ead;">mut</span><span style="color:#c0c5ce;"> revwalk) = repo.</span><span style="color:#96b5b4;">revwalk</span><span style="color:#c0c5ce;">() {

        revwalk.</span><span style="color:#96b5b4;">push_head</span><span style="color:#c0c5ce;">(); </span><span style="color:#65737e;">// this is required before revwalk is started

        </span><span style="color:#c0c5ce;">println!(&quot;</span><span style="color:#d08770;">{:?}</span><span style="color:#c0c5ce;">&quot;, revwalk.</span><span style="color:#96b5b4;">next</span><span style="color:#c0c5ce;">());
    } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
        println!(&quot;</span><span style="color:#a3be8c;">error revwalk</span><span style="color:#c0c5ce;">&quot;);
    }
} </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
    println!(&quot;</span><span style="color:#a3be8c;">error repo</span><span style="color:#c0c5ce;">&quot;);
}
</span></pre>
<p>The <code>Item</code> of the <code>Iterator</code> in <code>Revwalk</code> struct is <code>Oid</code>, which is an identity of any object: commit, tree, blob, tag. In other words, it is a hash like this one <code>630d35363c52f4a65e902fafc404c0708532c4fe</code>. I needed to get the commit object. This time <code>log.c</code> didn't help me. It is using <code>git_commit_lookup</code> function, which I didn't find in the git2 crate. I needed to find it myself browsing the documentation of git2, and I found it, <code>find_commit</code> function. It is available on the <a href="https://docs.rs/git2/0.13.6/git2/struct.Repository.html#method.find_commit">Repository</a> struct. I would say git2 rust api is well structured, I like it.</p>
<p>With <code>find_commit</code> function, I can finally do what I need, take the author and the commit title. The <code>Commit</code> object has all needed functions</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">summarize</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">commit</span><span style="color:#c0c5ce;">: &amp;Commit) -&gt; String {
    </span><span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> name: String = commit.</span><span style="color:#96b5b4;">author</span><span style="color:#c0c5ce;">().</span><span style="color:#96b5b4;">name</span><span style="color:#c0c5ce;">().</span><span style="color:#96b5b4;">map_or</span><span style="color:#c0c5ce;">(&quot;&quot;.</span><span style="color:#96b5b4;">into</span><span style="color:#c0c5ce;">(), |</span><span style="color:#bf616a;">name</span><span style="color:#c0c5ce;">| name.</span><span style="color:#96b5b4;">into</span><span style="color:#c0c5ce;">());
    </span><span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> short = commit
        .</span><span style="color:#96b5b4;">summary</span><span style="color:#c0c5ce;">()
        .</span><span style="color:#96b5b4;">map</span><span style="color:#c0c5ce;">(|</span><span style="color:#bf616a;">s</span><span style="color:#c0c5ce;">| String::from(s))
        .</span><span style="color:#96b5b4;">unwrap_or</span><span style="color:#c0c5ce;">(&quot;&quot;.</span><span style="color:#96b5b4;">into</span><span style="color:#c0c5ce;">());
    format!(&quot;</span><span style="color:#d08770;">{} {}</span><span style="color:#c0c5ce;">&quot;, name, short)
}
</span></pre><h2 id="getting-time-range-for-one-day-a-year-ago"><a href="https://bprog.github.io/rust_slack_bot/#getting-time-range-for-one-day-a-year-ago">Getting time range for one day a year ago</a></h2>
<p>I needed a time range of one day for a year ago, for example if today is <code>2020/05/28</code>, then, I needed the range of date and time: <code>2019/05/28 00:00:00 - 2019/05/29 00:00:00</code>. Date and time in general is not a simple topic. I didn't dive deeper into all aspects of the time, I needed only a simple use case. The standard library does not include a date time struct that I can use. So I needed to add some 3rd party crate. I found <a href="https://crates.io/crates/chrono">chrono</a>, a great library.</p>
<p>I created a <code>create_naive_date_time_range</code> function, which returns a tuple with 2 date time objects, given the today date time. Naive types are DateTime without timezones, they are not aware of timezone. More documentation on this is in the <code>chrono</code>s documentation <a href="https://docs.rs/chrono/0.4.11/chrono/#naive-date-and-time">here</a></p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">create_naive_date_time_range</span><span style="color:#c0c5ce;">(
    </span><span style="color:#bf616a;">today</span><span style="color:#c0c5ce;">: &amp;NaiveDateTime,
    </span><span style="color:#bf616a;">years_back</span><span style="color:#c0c5ce;">: </span><span style="color:#b48ead;">i32</span><span style="color:#c0c5ce;">,
) -&gt; (NaiveDateTime, NaiveDateTime) {
    </span><span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> year_ago_date = NaiveDate::from_ymd(
        today.</span><span style="color:#96b5b4;">date</span><span style="color:#c0c5ce;">().</span><span style="color:#96b5b4;">year</span><span style="color:#c0c5ce;">() - years_back,
        today.</span><span style="color:#96b5b4;">date</span><span style="color:#c0c5ce;">().</span><span style="color:#96b5b4;">month</span><span style="color:#c0c5ce;">(),
        today.</span><span style="color:#96b5b4;">date</span><span style="color:#c0c5ce;">().</span><span style="color:#96b5b4;">day</span><span style="color:#c0c5ce;">(),
    );
    </span><span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> year_ago_next_day_date = year_ago_date.</span><span style="color:#96b5b4;">succ</span><span style="color:#c0c5ce;">();
    </span><span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> year_ago_date_time = NaiveDateTime::new(year_ago_date, NaiveTime::from_hms(</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">));
    </span><span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> year_ago_next_day_date_time =
        NaiveDateTime::new(year_ago_next_day_date, NaiveTime::from_hms(</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">));

    (year_ago_date_time, year_ago_next_day_date_time)
}
</span></pre>
<p>To create the today date time, I used <code>SystemTime</code> from std library</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">get_today_naive_date_time</span><span style="color:#c0c5ce;">() -&gt; NaiveDateTime {
    </span><span style="color:#b48ead;">if let </span><span style="color:#c0c5ce;">Ok(now) = SystemTime::now().</span><span style="color:#96b5b4;">duration_since</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">UNIX_EPOCH</span><span style="color:#c0c5ce;">) {
        NaiveDateTime::from_timestamp(now.</span><span style="color:#96b5b4;">as_secs</span><span style="color:#c0c5ce;">() as </span><span style="color:#b48ead;">i64</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)
    } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
        NaiveDate::from_ymd(</span><span style="color:#d08770;">2020</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">04</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">28</span><span style="color:#c0c5ce;">).</span><span style="color:#96b5b4;">and_hms</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">22</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">51</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">28</span><span style="color:#c0c5ce;">)
    }
}
</span></pre>
<p>Git has it's own Time struct, and I had to convert the <code>NaiveDateTime</code> into a git2 <code>Time</code>.</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">use </span><span style="color:#c0c5ce;">git2::{Time};

</span><span style="color:#b48ead;">let </span><span style="color:#c0c5ce;">(time_from, time_to) = (
    Time::new(datetime_from.</span><span style="color:#96b5b4;">timestamp</span><span style="color:#c0c5ce;">(), </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">),
    Time::new(datetime_to.</span><span style="color:#96b5b4;">timestamp</span><span style="color:#c0c5ce;">(), </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">),
);
</span></pre>
<p><strong>Note</strong>: <em>Later I realized that this step is unnecessary step, and I can just use seconds to compare the times.</em></p>
<h2 id="creating-the-slack-message"><a href="https://bprog.github.io/rust_slack_bot/#creating-the-slack-message">Creating the slack message</a></h2>
<p>I have used fold on the revwalker, as I said earlier, <code>Revwalk</code> implements <code>Iterator</code>. Firs I created a Vector of strings containing: <strong>Author Message</strong></p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> summary = revwalk.</span><span style="color:#96b5b4;">fold</span><span style="color:#c0c5ce;">(Vec::&lt;String&gt;::new(), |</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">summary</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">oid</span><span style="color:#c0c5ce;">| </span><span style="color:#b48ead;">match</span><span style="color:#c0c5ce;"> oid {
    Err(_) =&gt; summary,
    Ok(oid) =&gt; </span><span style="color:#b48ead;">match</span><span style="color:#c0c5ce;"> repo.</span><span style="color:#96b5b4;">find_commit</span><span style="color:#c0c5ce;">(oid) {
        Err(_) =&gt; summary,
        Ok(commit) =&gt; {
            </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#96b5b4;">is_valid_commit</span><span style="color:#c0c5ce;">(&amp;commit, &amp;from, &amp;to) {
                summary.</span><span style="color:#96b5b4;">push</span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">summarize</span><span style="color:#c0c5ce;">(&amp;commit));
            }
            summary
        }
    },
</span></pre>
<p>With this vector, I need to just decorate it with a little emojis üíÑ</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">const </span><span style="color:#d08770;">SUFFIX_EMOJIES</span><span style="color:#c0c5ce;">: [</span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;">; </span><span style="color:#d08770;">10</span><span style="color:#c0c5ce;">] = [&#39;</span><span style="color:#a3be8c;">üôå</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">üëç</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">üôè</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">üéâ</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">üöÄ</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">ü§ò</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">üëè</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">üôå</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">üëç</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">üôè</span><span style="color:#c0c5ce;">&#39;];
</span><span style="color:#b48ead;">const </span><span style="color:#d08770;">START_ROW</span><span style="color:#c0c5ce;">: &amp;</span><span style="color:#b48ead;">str </span><span style="color:#c0c5ce;">= </span><span style="color:#b48ead;">r</span><span style="color:#c0c5ce;">#</span><span style="color:#a3be8c;">&quot;
A reminder on how cool you all are üòé
A year ago, this same day you&#39;ve written history üìú
</span><span style="color:#c0c5ce;">&quot;#;

</span><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">prettify</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">commits</span><span style="color:#c0c5ce;">: &amp;Vec&lt;String&gt;) -&gt; String {
    </span><span style="color:#b48ead;">let mut</span><span style="color:#c0c5ce;"> index = </span><span style="color:#d08770;">0</span><span style="color:#b48ead;">usize</span><span style="color:#c0c5ce;">;
    </span><span style="color:#b48ead;">let mut</span><span style="color:#c0c5ce;"> commits_count = </span><span style="color:#d08770;">0</span><span style="color:#b48ead;">u16</span><span style="color:#c0c5ce;">;
    </span><span style="color:#b48ead;">let mut</span><span style="color:#c0c5ce;"> pretty = commits
        .</span><span style="color:#96b5b4;">iter</span><span style="color:#c0c5ce;">()
        .</span><span style="color:#96b5b4;">fold</span><span style="color:#c0c5ce;">(String::from(</span><span style="color:#d08770;">START_ROW</span><span style="color:#c0c5ce;">), |</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">pretty</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">commit</span><span style="color:#c0c5ce;">| {
            pretty.</span><span style="color:#96b5b4;">push_str</span><span style="color:#c0c5ce;">(&amp;format!(&quot;</span><span style="color:#a3be8c;">‚òû </span><span style="color:#d08770;">{} {} </span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;, commit, </span><span style="color:#d08770;">SUFFIX_EMOJIES</span><span style="color:#c0c5ce;">[index]));
            index = </span><span style="color:#96b5b4;">increase_index</span><span style="color:#c0c5ce;">(index);
            commits_count += </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
            pretty
        });
    pretty.</span><span style="color:#96b5b4;">push_str</span><span style="color:#c0c5ce;">(&amp;format!(&quot;</span><span style="color:#d08770;">{}</span><span style="color:#a3be8c;"> merged commits in one day</span><span style="color:#c0c5ce;">&quot;, commits_count));
    </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;"> commits_count == </span><span style="color:#d08770;">0 </span><span style="color:#c0c5ce;">{
        &quot;&quot;.</span><span style="color:#96b5b4;">into</span><span style="color:#c0c5ce;">()
    } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
        pretty
    }
}
</span></pre>
<p><strong>Note</strong>: <em>Skin color emojis cannot be used, char does not support it. A very good explanation on this topic is <a href="https://hsivonen.fi/string-length/">here</a></em></p>
<p>The final message is ready to be send to slack üôå</p>
<h2 id="configuration"><a href="https://bprog.github.io/rust_slack_bot/#configuration">Configuration</a></h2>
<p>I needed a config file to save and load webhook and git repo path. I chose <a href="https://crates.io/crates/confy">confy</a> because of it's simplicity.</p>
<p>The main thing I had to figure out, is where to save the configurations files. I wanted to do it in the correct way. OSX has a standard path for configuration files of the installed apps. The documentation about app's configuration files <a href="https://developer.apple.com/library/archive/documentation/FileManagement/Conceptual/FileSystemProgrammingGuide/FileSystemOverview/FileSystemOverview.html#//apple_ref/doc/uid/TP40010672-CH2-SW6">here</a>. But, after reading the documentation there, I was thinking that for a CLI app which is going to be used by an engineer, it might not the best place to put config file. So I decided to see what are other options. <a href="https://specifications.freedesktop.org/basedir-spec/basedir-spec-latest.html">Unix structure</a> is more friendly to me and maybe many engineers who like to use terminal and cli apps. So I decided to save the file in <code>$HOME/.config/&lt;app&gt;/</code></p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">get_config</span><span style="color:#c0c5ce;">() -&gt; Result&lt;Config, Box&lt;dyn Error&gt;&gt; {
    </span><span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> dirs = UserDirs::new().</span><span style="color:#96b5b4;">ok_or</span><span style="color:#c0c5ce;">(ConfigError::UserHome)?;
    </span><span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> path = dirs.</span><span style="color:#96b5b4;">home_dir</span><span style="color:#c0c5ce;">();
    </span><span style="color:#b48ead;">let mut</span><span style="color:#c0c5ce;"> path_buf = path.</span><span style="color:#96b5b4;">to_path_buf</span><span style="color:#c0c5ce;">();
    path_buf.</span><span style="color:#96b5b4;">push</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">.config</span><span style="color:#c0c5ce;">&quot;);
    path_buf.</span><span style="color:#96b5b4;">push</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">super</span><span style="color:#c0c5ce;">::</span><span style="color:#d08770;">APP_NAME</span><span style="color:#c0c5ce;">);
    path_buf.</span><span style="color:#96b5b4;">push</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">crate</span><span style="color:#c0c5ce;">::environment::get_config_file());
    path_buf.</span><span style="color:#96b5b4;">set_extension</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">toml</span><span style="color:#c0c5ce;">&quot;);
    </span><span style="color:#96b5b4;">load_path</span><span style="color:#c0c5ce;">(&amp;path_buf.</span><span style="color:#96b5b4;">as_path</span><span style="color:#c0c5ce;">()).</span><span style="color:#96b5b4;">map_err</span><span style="color:#c0c5ce;">(|</span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">| e.</span><span style="color:#96b5b4;">into</span><span style="color:#c0c5ce;">())
}
</span></pre><h2 id="daemonize-the-process"><a href="https://bprog.github.io/rust_slack_bot/#daemonize-the-process">Daemonize the process</a></h2>
<p>I didn't want to run the app myself everyday, it needs to be run automatically by the operating system, and because I am using a Mac, I needed to create a launch agent for mac, <a href="https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingLaunchdJobs.html">apple documentation</a> explains very well how it works and how to create one.</p>
<p>Basically I need to create a <code>plist</code> file in the <code>~/Library/LaunchAgents/</code> folder. I wanted to make my launch agent to run every weekday at 10:00. To achieve this, I had to use <code>StartCalendarInterval</code> key and a <code>dict</code> sections for every day.</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">key</span><span style="color:#c0c5ce;">&gt;StartCalendarInterval&lt;/</span><span style="color:#bf616a;">key</span><span style="color:#c0c5ce;">&gt;
    &lt;</span><span style="color:#bf616a;">array</span><span style="color:#c0c5ce;">&gt;
      &lt;</span><span style="color:#bf616a;">dict</span><span style="color:#c0c5ce;">&gt;
        &lt;</span><span style="color:#bf616a;">key</span><span style="color:#c0c5ce;">&gt;Weekday&lt;/</span><span style="color:#bf616a;">key</span><span style="color:#c0c5ce;">&gt;
        &lt;</span><span style="color:#bf616a;">integer</span><span style="color:#c0c5ce;">&gt;1&lt;/</span><span style="color:#bf616a;">integer</span><span style="color:#c0c5ce;">&gt;
        &lt;</span><span style="color:#bf616a;">key</span><span style="color:#c0c5ce;">&gt;Hour&lt;/</span><span style="color:#bf616a;">key</span><span style="color:#c0c5ce;">&gt;
        &lt;</span><span style="color:#bf616a;">integer</span><span style="color:#c0c5ce;">&gt;10&lt;/</span><span style="color:#bf616a;">integer</span><span style="color:#c0c5ce;">&gt;
        &lt;</span><span style="color:#bf616a;">key</span><span style="color:#c0c5ce;">&gt;Minute&lt;/</span><span style="color:#bf616a;">key</span><span style="color:#c0c5ce;">&gt;
        &lt;</span><span style="color:#bf616a;">integer</span><span style="color:#c0c5ce;">&gt;00&lt;/</span><span style="color:#bf616a;">integer</span><span style="color:#c0c5ce;">&gt;
      &lt;/</span><span style="color:#bf616a;">dict</span><span style="color:#c0c5ce;">&gt;
</span></pre>
<p>To make the process simple, I wanted to add a command to be able to generate this file automatically using cli. So I added <code>gitretro installd</code> command, about commands on the next chapter <a href="https://bprog.github.io/rust_slack_bot/#commands">commands</a></p>
<p>As per apple documentation, there a <code>Program</code> field which represents the path to the executable in the plist file. So I needed the path to executable</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> exe_path = std::env::current_exe()?;
</span></pre>
<p>And generates the <code>plist</code> at the required path. I used the <a href="https://crates.io/crates/directories">directories</a> to generate the path</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> dirs = UserDirs::new().</span><span style="color:#96b5b4;">ok_or</span><span style="color:#c0c5ce;">(DaemonError::UserHome)?;
</span><span style="color:#b48ead;">let mut</span><span style="color:#c0c5ce;"> path_buf = dirs.</span><span style="color:#96b5b4;">home_dir</span><span style="color:#c0c5ce;">().</span><span style="color:#96b5b4;">to_path_buf</span><span style="color:#c0c5ce;">();
path_buf.</span><span style="color:#96b5b4;">push</span><span style="color:#c0c5ce;">(format!(
    &quot;</span><span style="color:#a3be8c;">Library/LaunchAgents/</span><span style="color:#d08770;">{}</span><span style="color:#a3be8c;">.plist</span><span style="color:#c0c5ce;">&quot;,
    </span><span style="color:#b48ead;">crate</span><span style="color:#c0c5ce;">::environment::get_launch_agent_file()
));
</span></pre>
<p>Write data to the file</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">let</span><span style="color:#c0c5ce;"> data = </span><span style="color:#96b5b4;">create_launch_agent_plist_content</span><span style="color:#c0c5ce;">()?;
file.</span><span style="color:#96b5b4;">write</span><span style="color:#c0c5ce;">(data.</span><span style="color:#96b5b4;">as_bytes</span><span style="color:#c0c5ce;">())?;
Ok(path_buf.</span><span style="color:#96b5b4;">to_string_lossy</span><span style="color:#c0c5ce;">().</span><span style="color:#96b5b4;">into</span><span style="color:#c0c5ce;">())
</span></pre><h2 id="commands"><a href="https://bprog.github.io/rust_slack_bot/#commands">Commands</a></h2>
<p>I love rust for how easy it is to handle cli commands, and I love <a href="https://rust-cli.github.io/book/tutorial/index.html">this tutorial</a>.</p>
<p>I wanted to handle a few commands: <code>run, installd, config, help</code> where:</p>
<ul>
<li>run: runs the app</li>
<li>installd: creates a plist configuration for launch agent and writes it in user launch agents folder</li>
<li>config: asks for repo path and slack web hook and saves the file</li>
<li>help: <em>no explanation needed</em></li>
</ul>
<p>I created an enum</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">pub enum </span><span style="color:#c0c5ce;">Command {
    Config,
    Run,
    InstallD,
    Invalid,
    Help
}
</span></pre>
<p>Read the arguments passed to the app, but skip first one, because first argument is the binary path</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">let mut</span><span style="color:#c0c5ce;"> args = env::args().</span><span style="color:#96b5b4;">into_iter</span><span style="color:#c0c5ce;">().</span><span style="color:#96b5b4;">skip</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);
</span></pre>
<p>And then read the next argument</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">match</span><span style="color:#c0c5ce;"> args.</span><span style="color:#96b5b4;">next</span><span style="color:#c0c5ce;">() {
    Some(command) =&gt; {
        </span><span style="color:#b48ead;">match </span><span style="color:#c0c5ce;">&amp;command[..] {
            &quot;</span><span style="color:#a3be8c;">run</span><span style="color:#c0c5ce;">&quot; =&gt; Command::Run,
            &quot;</span><span style="color:#a3be8c;">config</span><span style="color:#c0c5ce;">&quot; =&gt; Command::Config,
            &quot;</span><span style="color:#a3be8c;">installd</span><span style="color:#c0c5ce;">&quot; =&gt; Command::InstallD,
            &quot;</span><span style="color:#a3be8c;">--help</span><span style="color:#c0c5ce;">&quot; | &quot;</span><span style="color:#a3be8c;">-h</span><span style="color:#c0c5ce;">&quot; =&gt; Command::Help,
            _ =&gt; Command::Invalid
        }
    },
    None =&gt; Command::Invalid
}
</span></pre>
<p><strong>Note</strong>: <em>String cannot be used as an argument to <code>match</code>, to bypass this, use full range slice <code>&amp;command[..]</code></em></p>
<h2 id="environments"><a href="https://bprog.github.io/rust_slack_bot/#environments">Environments</a></h2>
<p>The release version of the app sends messages to an internal channel of our team. While developing and testing features I needed to send messages to myself in slack. I needed 2 environments because the <em>release</em> version of the application will run as a daemon on my PC. In order to run 2 versions of the app, every instance of the app needs it's own config file, and it's own daemon configuration (plist).</p>
<p>I knew nothing about how this is done in rust. After some search on the internet, I decided to use <a href="https://doc.rust-lang.org/reference/conditional-compilation.html">conditional compilation</a>. In the rust reference book, it is explained how to use <code>--cfg</code> flag with the rust compiler. But I am using <code>cargo</code> so I wanted more high-level way to handle this. And there is one: <a href="https://doc.rust-lang.org/cargo/reference/features.html">cargo features</a></p>
<p>Add this section to <code>cargo.toml</code></p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">[features]
</span><span style="color:#bf616a;">default </span><span style="color:#c0c5ce;">= []
</span><span style="color:#bf616a;">production </span><span style="color:#c0c5ce;">= []
</span></pre>
<p>When a production executable is needed: <code>cargo build --release --features &quot;production&quot;</code></p>
<p>In code, the <code>cfg!</code> is used:</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">get_config_file</span><span style="color:#c0c5ce;">() -&gt; &amp;</span><span style="color:#b48ead;">&#39;static str </span><span style="color:#c0c5ce;">{
    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">cfg!(feature = &quot;</span><span style="color:#a3be8c;">production</span><span style="color:#c0c5ce;">&quot;) {
        &quot;</span><span style="color:#a3be8c;">config</span><span style="color:#c0c5ce;">&quot;
    } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
        &quot;</span><span style="color:#a3be8c;">config_dev</span><span style="color:#c0c5ce;">&quot;
    }
}

</span><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">get_launch_agent_file</span><span style="color:#c0c5ce;">() -&gt; &amp;</span><span style="color:#b48ead;">&#39;static str </span><span style="color:#c0c5ce;">{
    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">cfg!(feature = &quot;</span><span style="color:#a3be8c;">production</span><span style="color:#c0c5ce;">&quot;) {
        &quot;</span><span style="color:#a3be8c;">com.ionostafi.gitretro</span><span style="color:#c0c5ce;">&quot;
    } </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
        &quot;</span><span style="color:#a3be8c;">com.ionostafi.gitretro_dev</span><span style="color:#c0c5ce;">&quot;
    }
}
</span></pre><h2 id="next"><a href="https://bprog.github.io/rust_slack_bot/#next">Next</a></h2>
<p>There are some technical things I am looking to improve in the future</p>
<ul>
<li>reduce binary size</li>
<li>reduce crates count</li>
<li>research a more correct way for setting up dev and prod environments</li>
</ul>
<p>And some app improvements</p>
<ul>
<li>group messages per author</li>
<li>order by author commits number in that day</li>
<li>support plurals</li>
<li>log to a temp file while launch agent is running</li>
</ul>
<p>While writing this blog, I realized, tokio crate is used only for it's futures runtime. This is first crate to be removed.</p>
<h2 id="conclusion"><a href="https://bprog.github.io/rust_slack_bot/#conclusion">Conclusion</a></h2>
<p>The initial goal was to feel for myself, the benefit of rust in a real world application. There is a steep learning curve at the beginning but once it is bypassed, the language is a beast in it's world. When I started to understand the language better, everything starts to make sense. It is hard to miss an unhappy path in the code, while on other languages it is easy to do so, here in rust, I feel like I am obligated to handle all the possible fails. It makes the application more error prone and gives the programmer a stronger feel of reliability.</p>

</div>

        </div>

    </body>

</html>
